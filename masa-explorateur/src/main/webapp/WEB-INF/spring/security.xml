<?xml version="1.0" encoding="UTF-8"?>
<beans:beans 
	xmlns="http://www.springframework.org/schema/security"
	xmlns:beans="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/security
           http://www.springframework.org/schema/security/spring-security.xsd">
	
	<http pattern="/login**" security="none"/>
	<http pattern="/favicon.ico" security="none"/>

	<http>
		<intercept-url pattern="/admin" 		access="hasAnyRole('ROLE_ADMIN', 'ROLE_USER')" />
	
		
			
		<form-login 
		    login-page="/login"
		    username-parameter="username"
		    password-parameter="password"
		    login-processing-url="/j_spring_security_check"
		    default-target-url="/admin"
			authentication-failure-url="/login?error"
		/>
		
		<logout invalidate-session="true"  logout-success-url="/login?logout" delete-cookies="JSESSIONID" />
		
		<!-- disable csrf protection -->
		<csrf disabled="true"/>
		
	
		<!-- 		<remember-me /> -->
		<headers>
			<cache-control />
			<xss-protection />
		</headers>
		
		<session-management invalid-session-url="/home">
			<!--Adding max-sessions attribut to define the number of session.
				A negative value enabled multiple sessions for user -->
            <concurrency-control expired-url="/home" max-sessions="-1"/>
        </session-management>
	</http>
 	
    <authentication-manager>
		<authentication-provider ref="MasaAuthenticationProvider">
		</authentication-provider>
	</authentication-manager>
	<beans:bean id="MasaAuthenticationProvider" class="fr.humanum.masa.user.MasaAuthenticationProvider" />

	<!-- 
    <context:component-scan base-package="fr.humanum.nakala.server.security" />

    <security:http pattern="/api/**" security="none" />
    <security:http pattern="/data/**" security="none" />
    <security:http pattern="/password/**" security="none" />
    <security:http pattern="/nakala.xsd" security="none" />
    <security:http pattern="/uploadPacket/**" security="none" />
    <security:http pattern="/consoleUploadPacket/**" security="none" />
    <security:http pattern="/login*" security="none"/>
    <security:http pattern="/gwtRequest" security="none"/>
    <security:http pattern="/error.jsp" security="none"/>
    <security:http pattern="/favicon.ico" security="none"/>

    <security:http entry-point-ref="customEntryPoint" auto-config="true" pattern="/renater_login">
        <security:custom-filter ref="preauthenticationFilter" position="PRE_AUTH_FILTER" />
        <security:logout invalidate-session="true" logout-success-url="/../Shibboleth.sso/Logout" logout-url="/logout"/>
        <security:intercept-url pattern="/renater_login" access="ROLE_USER, ROLE_ADMIN"/>
    </security:http>

    <bean id="customEntryPoint" class="fr.humanum.nakala.server.security.SiloAuthenticationEntryPoint">
        <property name="domainLogin" value="/loginfailed"/>
    </bean>

    <bean id="preauthenticationFilter" class="org.springframework.security.web.authentication.preauth.RequestHeaderAuthenticationFilter">
        <property name="principalRequestHeader" value="mail"/>
        <property name="authenticationManager" ref="authenticationManagerRenater" />
        <property name="exceptionIfHeaderMissing" value="false" />
    </bean>

    <bean id="loginSuccessHandler" class="fr.humanum.nakala.server.security.LoginSuccessHandler" >
        <property name="defaultTargetUrl" value="/selectProject" />
            </bean>

    <security:http auto-config="true" authentication-manager-ref="authenticationManager">
        <security:logout logout-url="/logout"/>
        <security:form-login login-page="/login" default-target-url="/selectProject" authentication-success-handler-ref="loginSuccessHandler"
                    authentication-failure-url="/loginfailed" />
        <security:intercept-url pattern="error.jsp" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <security:intercept-url pattern="/admin/**" access="ROLE_ADMIN" />
        <security:intercept-url pattern="/selectProject" access="ROLE_USER, ROLE_ADMIN, ROLE_NO_PROJECT" />
        <security:intercept-url pattern="/index.jsp" access="ROLE_USER, ROLE_ADMIN" />
        <security:intercept-url pattern="/fr/humanum/nakala/client/rpc" access="ROLE_USER" />
        <security:intercept-url pattern="/**" access="ROLE_USER" />

        <security:session-management invalid-session-url="/login">
            <security:concurrency-control expired-url="/login"/>
        </security:session-management>
    </security:http>

    <security:authentication-manager alias="authenticationManager">
        <security:authentication-provider ref="siloAuthenticationProvider" />
    </security:authentication-manager>

    <security:authentication-manager id="authenticationManagerRenater">
        <security:authentication-provider ref="renaterPreAuthenticatedAuthenticationProvider" />
    </security:authentication-manager>
	-->
</beans:beans>